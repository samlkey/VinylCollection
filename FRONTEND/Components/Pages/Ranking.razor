@page "/ranking"
@rendermode InteractiveServer
@using FRONTEND.Services
@using FRONTEND.Data
@using FRONTEND.Components.Shared

@inject IVinylService VinylService
@inject IColorAnalysisService ColorService
@inject ICurrentAlbumColorService CurrentAlbumColorService
@inject NavigationManager Navigation

<PageTitle>Ranking</PageTitle>

@{
    var currentAlbum = rankedAlbums[currentAlbumIndex];
    CurrentAlbumColorService.CurrentAlbumColor = currentAlbum.PrimaryColour ?? "#000000";
    var textColor = CurrentAlbumColorService.TextColor;
    var layoutTextColor = CurrentAlbumColorService.IsColorBright ? "black" : "white";
}

<div class="container" style="--album-bg:@(currentAlbum.PrimaryColour ?? "#000000"); --layout-text-color:@layoutTextColor;" 
     @ref="_keyTarget"
     @onkeydown="HandleKeyDown"
     tabindex="0">

    <Search IsBackVisible="false" />
    
    @if (rankedAlbums != null && rankedAlbums.Count > 0)
    {
        <div class="ranking-content">
            <h1 style="@textColor">@(currentAlbumIndex+1)</h1>
            <div class="carousel-section">
                @* Left Side Controls *@
                <button class="carousel-btn carousel-btn-left" @onclick="PreviousAlbum" disabled="@(currentAlbumIndex <= 0)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="color: var(--layout-text-color, white);">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                    </svg>
                </button>

                <div class="carousel-wrapper">
                    <div class="carousel-track @(currentAlbumIndex == rankedAlbums.Count - 1 ? "centered" : "") @(currentAlbumIndex == 0 ? "first-item" : "")" @key="currentAlbumIndex">
                        @{
                            var prevIndex = GetPreviousIndex();
                            var nextIndex = GetNextIndex();
                        }

                        @* Previous Album *@
                        @if (rankedAlbums.Count > 1 && currentAlbumIndex != 0)
                        {
                            var prevAlbum = rankedAlbums[prevIndex];
                            <div class="carousel-item prev" @onclick="PreviousAlbum" @key="@prevIndex">
                                <div class="carousel-album-card">
                                    <img src="@prevAlbum.ImgSrc" alt="@prevAlbum.Name" class="carousel-album-art" />
                                    <div class="carousel-album-info">
                                        <h3 style="@textColor">@prevAlbum.Name</h3>
                                        <p class="artist" style="@textColor">@prevAlbum.Artist</p>
                                        <div class="rating-display">
                                            <Rating Value="@prevAlbum.Rating" TextColor="@textColor"></Rating>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        @* Current Album *@
                        @{
                            var rankingPosition = currentAlbumIndex + 1;
                        }
                        <div class="carousel-item current" @onclick="() => NavigateToAlbum(currentAlbum.Id)" @key="@currentAlbumIndex">
                            <div class="carousel-album-card">
                                <img src="@currentAlbum.ImgSrc" alt="@currentAlbum.Name" class="carousel-album-art" />
                                <div class="carousel-album-info">
                                    <h3 style="@textColor">@currentAlbum.Name</h3>
                                    <p class="artist" style="@textColor">@currentAlbum.Artist</p>
                                    <div class="rating-display">
                                        <Rating Value="@currentAlbum.Rating" TextColor="@textColor"></Rating>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Next Album *@
                        @if (rankedAlbums.Count > 1 && currentAlbumIndex != rankedAlbums.Count-1)
                        {
                            var nextAlbum = rankedAlbums[nextIndex];
                            <div class="carousel-item next" @onclick="NextAlbum" @key="@nextIndex">
                                <div class="carousel-album-card">
                                    <img src="@nextAlbum.ImgSrc" alt="@nextAlbum.Name" class="carousel-album-art" />
                                    <div class="carousel-album-info">
                                        <h3 style="@textColor">@nextAlbum.Name</h3>
                                        <p class="artist" style="@textColor">@nextAlbum.Artist</p>
                                        <div class="rating-display">
                                            <Rating Value="@nextAlbum.Rating" TextColor="@textColor"></Rating>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* Right Side Controls *@
                <button class="carousel-btn carousel-btn-right" @onclick="NextAlbum" disabled="@(currentAlbumIndex >= rankedAlbums.Count - 1)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="color: var(--layout-text-color, white); transform: scaleX(-1);">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                    </svg>
                </button>
            </div>
        </div>
    }
</div>

@code {
    private List<Album> albums = new List<Album>();
    private List<Album> rankedAlbums = new List<Album>();
    private int currentAlbumIndex = 0;
    private ElementReference _keyTarget;

    protected override async Task OnInitializedAsync() {
        albums = await VinylService.GetAllAlbumsAsync();
        rankedAlbums = GetAlbumsByRating();
        
        // Start at the lowest rated album (last in the list)
        if (rankedAlbums.Count > 0)
        {
            currentAlbumIndex = rankedAlbums.Count - 1;
        }
        
        // Calculate colors for albums that don't have them
        foreach (var album in rankedAlbums)
        {
            if (string.IsNullOrEmpty(album.PrimaryColour))
            {
                await album.CalculatePrimaryColourAsync(ColorService);
            }
        }
    }

    private List<Album> GetAlbumsByRating() => albums.OrderByDescending(a => a.Rating).ToList();

    private void NavigateToAlbum(int albumId)
    {
        Navigation.NavigateTo($"/album/{albumId}");
    }

    private void NextAlbum()
    {
        if (rankedAlbums.Count > 0 && currentAlbumIndex < rankedAlbums.Count - 1)
        {
            currentAlbumIndex = currentAlbumIndex + 1;
        }
    }

    private void PreviousAlbum()
    {
        if (rankedAlbums.Count > 0 && currentAlbumIndex > 0)
        {
            currentAlbumIndex = currentAlbumIndex - 1;
        }
    }

    private void SetAlbumIndex(int index)
    {
        if (index >= 0 && index < rankedAlbums.Count)
        {
            currentAlbumIndex = index;
        }
    }

    private int GetPreviousIndex()
    {
        if (rankedAlbums.Count == 0) return 0;
        if (currentAlbumIndex <= 0) return 0;
        return currentAlbumIndex - 1;
    }

    private int GetNextIndex()
    {
        if (rankedAlbums.Count == 0) return 0;
        if (currentAlbumIndex >= rankedAlbums.Count - 1) return rankedAlbums.Count - 1;
        return currentAlbumIndex + 1;
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "ArrowRight")
        {
            NextAlbum();
            await InvokeAsync(StateHasChanged);
        }
        else if (e.Key == "ArrowLeft")
        {
            PreviousAlbum();
            await InvokeAsync(StateHasChanged);
        }
    }
}